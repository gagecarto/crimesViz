function mapInits(){cartodb.createVis("map","http://gagecarto.cartodb.com/api/v2/viz/51a8cab0-5f82-11e3-8292-3085a9a9563c/viz.json",{shareable:false,title:false,infowindow:true,description:false,tiles_loader:true,legends:false,center_lat:45.68,center_lon:-111.05,zoom:13}).done(function(e,t){crimeLayer=t[1];mapLayers.push(crimeLayer);t[1].setInteraction(true);t[1].on("featureOver",function(e,t,n,r){});map=e.getNativeMap();map.options.maxZoom=17;map.options.minZoom=11;map.setMaxBounds([[45.20429,-112.20336],[46.15129,-109.89624]]);newBoundsObj=map.getBounds();map.on("zoomend",function(e){newBoundsObj=map.getBounds();dragQuery="yes";dateChange()});map.on("dragend",function(e){newBoundsObj=map.getBounds();dragQuery="yes";dateChange()});dateChange()}).error(function(e){console.log(e)});var e=new cartodb.SQL({user:"gagecarto"});e.execute("SELECT crimeType FROM crimesclassed_120713").done(function(e){returnedData=e.rows;summarizeReturned()}).error(function(e){console.log("errors:"+e)})}function removeHover(){alert(this.label)}function uiInits(){$("#welcomeDialog").dialog({resizable:false,autoOpen:true,draggable:true,width:650,height:550,modal:true,buttons:{Ok:function(){$(this).dialog("close")}}});$("#checks").buttonset();$("[type=checkbox]").change(function(){if(!$(this).is(":checked")){$(this).blur()}});$("#from").datepicker({yearRange:"-90:+0",defaultDate:"01/01/2013",minDate:"01/01/2002",maxDate:"11/30/2013",changeMonth:true,changeYear:true,numberOfMonths:1,onSelect:function(e){$("#to").datepicker("option","minDate",e);minDate=new Date(e);minDateString="'"+minDate.getFullYear()+"-"+(minDate.getMonth()+1)+"-"+minDate.getDate()+"'";minDateLiteral=minDate.getMonth()+1+"/"+minDate.getDate()+"/"+minDate.getFullYear();dragQuery="no";dateChange()}});$("#to").datepicker({yearRange:"-90:+0",defaultDate:"11/30/2013",minDate:"01/01/2002",maxDate:"11/30/2013",changeMonth:true,changeYear:true,numberOfMonths:1,onSelect:function(e){$("#from").datepicker("option","maxDate",e);maxDate=new Date(e);console.log(maxDate.getMonth());console.log(maxDate.getMonth()+1);maxDateString="'"+maxDate.getFullYear()+"-"+(maxDate.getMonth()+1)+"-"+maxDate.getDate()+"'";maxDateLiteral=maxDate.getMonth()+1+"/"+maxDate.getDate()+"/"+maxDate.getFullYear();dragQuery="no";dateChange()}});$("#slider").slider({range:false,min:0,max:24,step:1,value:24,change:function(e,t){sliderMax=t.value;console.log(sliderMax);if(sliderMax===24){$("#max").html("to 12:00am")}else if(sliderMax===0){$("#max").html("to 12:00am")}else if(sliderMax===12){$("#max").html("to 12:00pm")}else if(sliderMax>12){$("#max").html("to "+(sliderMax-12)+":00pm")}else{$("#max").html("to "+sliderMax+":00am")}dragQuery="no";dateChange()}});$("#slider2").slider({range:false,min:0,max:24,step:1,value:0,change:function(e,t){sliderMin=t.value;if(sliderMin===24){$("#min").html("from "+"12:00am")}else if(sliderMin===0){$("#min").html("from "+"12:00am")}else if(sliderMin===12){$("#min").html("from "+"12:00pm")}else if(sliderMin>12){$("#min").html("from "+(sliderMin-12)+":00pm")}else{$("#min").html("from "+sliderMin+":00am")}dragQuery="no";dateChange()}})}function dateChange(){var e="AND";if(sliderMin>sliderMax){console.log("gonna switch em");var e="OR"}if(selectedDays.length==0&&dragQuery=="no"){crimeLayer.getSubLayer(0).setSQL("SELECT * FROM crimesclassed_120713 WHERE date_part('dow',date)=8")}else{days="(";$.each(selectedDays,function(e){if(e+1==selectedDays.length){days+=selectedDays[e]}else{days+=selectedDays[e]+","}});days+=")";queryText="SELECT * FROM crimesclassed_120713 WHERE the_geom && ST_SetSRID(ST_MakeBox2D(ST_Point("+newBoundsObj._northEast.lng+", "+newBoundsObj._northEast.lat+"), ST_Point("+newBoundsObj._southWest.lng+", "+newBoundsObj._southWest.lat+")),4326) AND (date_part('dow',date) In "+days+") AND (date_part('hour',date)<="+sliderMax+" "+e+" date_part('hour',date)>= "+sliderMin+") AND (date>="+minDateString+") AND (date<="+maxDateString+")";informationString="You are currently viewing all crimes between the dates of "+minDateString+" and "+maxDateString+$("#min").html()+" "+$("#max").html()+"";var t=new cartodb.SQL({user:"gagecarto"});t.execute("SELECT crimetype FROM crimesclassed_120713 WHERE the_geom && ST_SetSRID(ST_MakeBox2D(ST_Point("+newBoundsObj._northEast.lng+", "+newBoundsObj._northEast.lat+"), ST_Point("+newBoundsObj._southWest.lng+", "+newBoundsObj._southWest.lat+")),4326) AND (date_part('dow',date) In "+days+") AND (date_part('hour',date)<="+sliderMax+" "+e+" date_part('hour',date)>= "+sliderMin+")AND (date>="+minDateString+") AND (date<="+maxDateString+")").done(function(e){returnedData=e.rows;summarizeReturned()}).error(function(e){console.log("errors:"+e)});crimeLayer.getSubLayer(0).setSQL(queryText)}}function dayClick(e){newDay=parseInt(e.slice(0,-1));var t=jQuery.inArray(newDay,selectedDays);if(t>=0){selectedDays.splice(t,1)}else{selectedDays.push(newDay)}dragQuery="no";dateChange()}function summarizeReturned(){selectedDays.sort();informationString="You are currently viewing "+Number(returnedData.length).toLocaleString("en")+" crimes between the dates of "+minDateLiteral+" and "+maxDateLiteral+". These crimes occured "+$("#min").html()+" "+$("#max").html()+"";if(selectedDays.length==7){informationString+=" on every day of the week."}else{var e=" on ";$.each(selectedDays,function(t){if(selectedDays.length==1){e+=dow[selectedDays[t]]}else if(t==selectedDays.length-1){e+=" and "+dow[selectedDays[t]]}else if(t==selectedDays.length-2){e+=dow[selectedDays[t]]+" "}else{e+=dow[selectedDays[t]]+", "}});informationString+=e+"."}$("#infoDiv").html(informationString);crimeJson=[{crimeType:"assault",totalCrimes:0,prctotal:0,smallLabel:"aslt",bigLabel:"Assault"},{crimeType:"burglary",totalCrimes:0,prctotal:0,smallLabel:"brglr",bigLabel:"Burglary"},{crimeType:"disorderlyConduct",totalCrimes:0,prctotal:0,smallLabel:"DSCN",bigLabel:"Dissorderly Conduct"},{crimeType:"drugs",totalCrimes:0,prctotal:0,smallLabel:"DRGS",bigLabel:"Drugs"},{crimeType:"dui",totalCrimes:0,prctotal:0,smallLabel:"DUI",bigLabel:"DUI"},{crimeType:"mischief",totalCrimes:0,prctotal:0,smallLabel:"mschf",bigLabel:"Mischief"},{crimeType:"theft",totalCrimes:0,prctotal:0,smallLabel:"thft",bigLabel:"Theft"},{crimeType:"trespass",totalCrimes:0,prctotal:0,smallLabel:"trsps",bigLabel:"Trespass"}];var t={};var n="crimetype";var r=returnedData.length;$.each(returnedData,function(){if(!t[this[n]])t[this[n]]=[];t[this[n]].push(this)});$.each(t,function(e){t[e]=t[e].length});$.each(t,function(e,t,n){$.each(crimeJson,function(n){if(e==crimeJson[n].crimeType){crimeJson[n].totalCrimes=t;crimeJson[n].prctotal=(t/r*100).toFixed(1)}})});dataSummed=crimeJson;if(start=="true"){d3Actions(dataSummed);start="false"}else{updatePie(dataSummed)}}function d3Actions(e){function w(e){var t=d3.interpolate(this._current,e);this._current=t(0);return function(e){return o(t(e))}}var t=400,n=400,r=Math.min(400,300)/2;var i=d3.scale.category20();var s=d3.layout.pie().sort(d3.ascending).value(function(e){return e.totalCrimes});var o=d3.svg.arc().outerRadius(r-10).innerRadius(r-70);var u=d3.svg.arc().outerRadius(r+40).innerRadius(r-20);var a=d3.select("#pieHolder").append("svg:svg").attr("width",t).attr("height",n);var f=a.append("svg:g").attr("class","arcGrp").attr("transform","translate("+t/2+","+n/2+")");var l=a.append("svg:g").attr("class","lblGroup").attr("transform","translate("+t/2+","+n/2+")");var c=a.append("svg:g").attr("class","ctrGroup").attr("transform","translate("+t/2+","+n/2+")");var h=a.append("svg:g").attr("class","ctrGroup").attr("transform","translate("+t/2+","+(n/2+20)+")");var p=a.append("svg:g").attr("class","ctrGroup").attr("transform","translate("+t/2+","+(n/2-20)+")");var d=c.append("text").attr("class","chartLabel").attr("text-anchor","middle").attr("font-size",".7em").style("fill","#17BFA0").style("font-weight","bold").text("Crimes by Type").style("text-shadow","black 0.1em 0.1em 0.2em");var v=h.append("text").attr("class","chartLabel").attr("text-anchor","middle").style("font-size",".7em").attr("fill","#17BFA0").style("font-weight","bold").style("text-shadow","black 0.1em 0.1em 0.2em");var m=p.append("text").attr("class","chartLabel").attr("text-anchor","middle").style("font-size",".7em").attr("fill","#17BFA0").style("font-weight","bold");var g=l.selectAll("text").data(s(e));g.enter().append("svg:text").attr("class","arcLabel").attr("transform",function(e){return"translate("+u.centroid(e)+")"}).attr("text-anchor","middle").attr("fill","#17BFA0").style("font-size",".7em").text(function(e){return e.data.smallLabel});var y=d3.svg.arc().innerRadius(85).outerRadius(r+5);var b=f.selectAll("path").data(s(e));b.enter().append("svg:path").attr("stroke","white").attr("stroke-width",.5).attr("fill",function(e,t){return i(t)}).attr("d",o).each(function(e){this._current=e}).on("mouseover",function(e,t){var n=d3.select(this).datum().data.bigLabel;var r=d3.select(this).datum().data.prctotal;var i=d3.select(this).datum().data.totalCrimes;d.text(n);v.text(r+"%");m.text(i);d3.select(this).transition().duration(100).attr("d",y)}).on("mouseout",function(e){d.text("Crimes by Type");v.text("");m.text("");$("#toolTipFloater").hide();d3.select(this).transition().attr("d",o)});this.updatePie=function(t){if(t.filter(function(e){return e.totalCrimes>0}).length>0){b.data(s(t)).enter().append("svg:path").attr("stroke","white").attr("stroke-width",.5).attr("fill",function(e,t){return i(t)}).attr("d",o).each(function(e){this._current=e});b.transition().ease("ease").duration(550).attrTween("d",w)}else{a.remove();start="true";return}g.data(s(t));g.transition().ease("east").duration(550).attr("transform",function(e){return"translate("+u.centroid(e)+")"}).style("fill-opacity",function(e){return e.value==0?1e-6:1})}}function testFunction(){console.log(map.getBounds())}var sliderValue;var sliderMin=0;var sliderMax=24;var mapLayers=[];var crimeLayer;var queryText;var withinTime=true;var selectedDays=[0,1,2,3,4,5,6];var newDay;var days;var returnedData;var dataSummed;var start="true";var crimeJson;var newBoundsObj;var minDate;var maxDate;var minDateString="'2013-01-01'";var maxDateString="'2013-11-30'";var minDateLiteral="01/01/2013";var maxDateLiteral="11/30/2013";var informationString;var dow=["Sundays","Mondays","Tuesdays","Wednesdays","Thursdays","Fridays","Saturdays"];var dragQuery="no";$(document).ready(function(){mapInits();uiInits()})